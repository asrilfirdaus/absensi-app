<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Aplikasi Absensi</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    .hidden {
      display: none;
    }
    input, select, button {
      margin: 5px 0;
      padding: 8px;
      width: 250px;
    }
    button {
      cursor: pointer;
    }
  </style>
</head>
<body>
  <h1>Aplikasi Absensi</h1>

  <!-- Form Login -->
  <div id="loginArea">
    <h2>Login</h2>
    <input id="username" placeholder="Username">
    <input id="password" type="password" placeholder="Password">
    <button id="btnLogin">Login</button>
  </div>

  <!-- Form Absensi -->
  <div id="absenArea" class="hidden">
    <h2>Absensi</h2>
    <p id="welcome"></p>

    <input id="idPekerja" placeholder="Barcode ID Pekerja" required>
    <input id="shift" placeholder="Shift (contoh: Shift 1)" required>
    <select id="typeScan">
      <option value="IN">Masuk</option>
      <option value="OUT">Pulang</option>
    </select>
    <input id="tglKerja" type="date" required>

    <button id="btnAbsen">Kirim Absensi</button>
    <button id="btnLogout" style="margin-top:10px;">Logout</button>
  </div>

  <script>
    // ðŸ‘‰ GANTI dengan URL Web App dari Apps Script (Deploy as Web App â†’ URL)
    const API_URL = "https://script.google.com/macros/s/AKfycbyeyqYzG2_cUQhzio9KxjYZ6bQ_q2YgdTM0LfH0UAKF8dFwZMHoMbwOyO8DLSnBPvRJ/exec";

    async function apiPost(data) {
      const res = await fetch(API_URL, {
        method: "POST",
        body: JSON.stringify(data),
        headers: {"Content-Type": "application/json"}
      });
      return await res.json();
    }

    function logout() {
      localStorage.removeItem("token");
      document.getElementById("loginArea").classList.remove("hidden");
      document.getElementById("absenArea").classList.add("hidden");
    }

    document.getElementById("btnLogin").addEventListener("click", async ()=>{
      const u = document.getElementById("username").value.trim();
      const p = document.getElementById("password").value.trim();
      try {
        const r = await apiPost({action:"login", username:u, password:p});
        if (r.token) {
          localStorage.setItem("token", r.token);
          document.getElementById("welcome").innerText = "Koordinator: " + u;
          document.getElementById("loginArea").classList.add("hidden");
          document.getElementById("absenArea").classList.remove("hidden");
        } else {
          alert(r.error || "Login gagal");
        }
      } catch(err) {
        alert("Error: " + err);
      }
    });

    document.getElementById("btnAbsen").addEventListener("click", async ()=>{
      const token = localStorage.getItem("token");
      if (!token) { alert("Silakan login dulu"); return; }

      const idPekerja = document.getElementById("idPekerja").value.trim();
      const shift = document.getElementById("shift").value.trim();
      const typeScan = document.getElementById("typeScan").value;
      const tglKerja = document.getElementById("tglKerja").value;

      if (!idPekerja || !shift || !tglKerja){
        alert("Lengkapi semua field");
        return;
      }

      try {
        const r = await apiPost({
          action:"attendance",
          token:token,
          idPekerja:idPekerja,
          shift:shift,
          typeScan:typeScan,
          tglKerja:tglKerja
        });
        if (r.status === "ok") {
          alert("Absensi berhasil âœ…");
        } else {
          alert(r.error || "Gagal absen");
          if (r.error && r.error.toLowerCase().includes("token")) {
            logout();
          }
        }
      } catch(err) {
        alert("Error: " + err);
      }
    });

    document.getElementById("btnLogout").addEventListener("click", logout);
  </script>
</body>
</html>
